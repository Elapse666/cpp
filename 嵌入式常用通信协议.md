# UART

### 串口波特率

**波特率**表示每秒钟传送的码元符号的个数

115200表示每秒钟能传输115200个位。

最大传输速率：不超过20kbps。即最大波特率为2000000

**报文格式**：起始位（1bit）+ 数据位（5~8bit）+ 奇偶校验位（1bit）+ 停止位（1~2bit）

**空闲状态**：当不传输数据时，UART数据传输线通常保持**高电平**。

**起始位**：UART将数据线拉到**低电平**，表示要开始传输数据。

**数据位**：数据为决定了通信过程中的有效数据位数量，数据为通常为**5-8位**。我通常是选择8位。

**奇偶校验位**：因为在通信过程中易受到外部干扰而导致数据出现偏差，所以在有效数据之后增加了校验位来解决这个问题

​		**奇校验：**奇校验要求有效数据和校验位中“1”的个数总和为奇数；

​		**偶校验**：偶校验则要求有效数据和校验位中“1”的个数总和为偶数；

**停止位**：停止位是一帧数据结束的标志，UART将数据线拉到**高电平**并保持1个位的时间。



**串口的优点：**

只需要两条线

不需要时钟或任何其他定时信号，只需要保持发送和接收设备保持相同的波特率。

有奇偶校验位，可以检查数据是否错误

**串口的缺点：**

每一帧中的数据位最多只有八个。

并行通信相比，数据传输的速度比较慢。



# IIC

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828181027990.png" alt="image-20230828181027990" style="zoom: 50%;" />

### IIC组成：

数据线SDA，时钟线SCL

**IIC最大速度**：**400kHz**

IIC支持多设备，但同一时间只能有一个主设备。

SCL、SDA都需要接上拉电阻。

IIC器件地址：每个IIC期间都有一个器件地址，用户基本不需要更改。

**空闲状态**：SCL、SDA被上拉电阻拉高，处于**高电平**。



**IIC开始信号**：**SCL** 为**高电平**时，**SDA** 由**高电平向低电平**跳变，开始传送数据。

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828183016959.png" alt="image-20230828183016959" style="zoom:50%;" />

**IIC结束信号**：**SCL** 为**高电平**时，**SDA** 由**低电平向高电平**跳变，结束传送数据。

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828183025229.png" alt="image-20230828183025229" style="zoom:50%;" />

**应答信号**：接收方在接收到 8bit 数据后，向发送方发出特定的**低电平脉冲**，表示已收到数据。

​				   主机**SCL拉高**，读取从机**SDA的电平**，为**低电平**表示产生应答

​					

**数据有效性**：当SCL=1高电平时，数据线SDA必须保持稳定状态，不允许有电平跳变。只有当SCL=0低电平时，数据线上SDA上的数据才允许变化。SCL=1时 数据线SDA的任何电平变换会看做是总线的起始信号或者停止信号。

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828183409042.png" alt="image-20230828183409042" style="zoom:50%;" />

**数据传输格式：**SDA数据线上的每个字节必须是8位，数据传输时，先传送最高位(MSB)，每个被传送的字节后面必须跟随一个应答位。即一帧数据有9位。

IIC的每一帧数据由9bit组成，

如果是**发送数据**，则包含 **8bit数据+1bit ACK,**

如果是**设备地址数据**，则**8bit(7bit设备地址 1bit方向)+1bit ACK**

传输方向：用**“0”**表示主机发送数据（W），**“1”**表示主机接收数据（R）

**数据传输过程**：**在起始信号后，主机发送一个从机的地址(7位) 1~7位为7位接收器件地址，第8位为读写位, 第9位为ACK应答位，接着的为第一个数据字节，然后是一位应答位，后面继续第2个数据字节。**



**IIC发送数据过程：**

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828204359281.png" alt="image-20230828204359281" style="zoom:80%;" />

1、主机首先产生START信号
2、然后紧跟着发送一个从机地址，这个地址共有7位，紧接着的第8位是数据方 向位(R/W)，0表示主机发送数据(写)，1表示主机接收数据(读)
3、主机发送地址时，总线上的每个从机都将这7位地址码与自己的地址进行比较，若相同，则认为自己正在被主机寻址，根据R/T位将自己确定为发送器和接收器
4、这时候主机等待从机的应答信号(A)
5、当主机收到应答信号时，发送要访问从机的那个地址， 继续等待从机的应答信号
6、当主机收到应答信号时，发送N个字节的数据，继续等待从机的N次应答信号，
7、主机产生停止信号，结束传送过程。



**IIC读数据过程：**

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828204537678.png" alt="image-20230828204537678" style="zoom:80%;" />

1、主机首先产生START信号
2、然后紧跟着发送一个从机地址，注意此时该地址的第8位为0，表明是向从机写命令，
3、这时候主机等待从机的应答信号(ACK)
4、当主机收到应答信号时，发送要访问的地址，继续等待从机的应答信号，
5、当主机收到应答信号后，主机要改变通信模式(主机将由发送变为接收，从机将由接收变为发送)所以主机重新发送一个开始start信号，然后紧跟着发送一个从机地址，注意此时该地址的第8位为1，表明将主机设 置成接收模式开始读取数据，
6、这时候主机等待从机的应答信号，当主机收到应答信号时，就可以接收1个字节的数据，当接收完成后，主机发送非应答信号，表示不在接收数据
7、主机进而产生停止信号，结束传送过程。





**IIC总线仲裁：**

IIC的总线仲裁建立在SDA数据线的线“与”功能上，当多个设备想要发送数据时，比较SDA数据线的电平与自己发送的电平是否相同，如果相同则继续发送，如果不相同则退出竞争。



**硬件IIC和软件IIC的区别：**

|        | 硬件IIC                        | 软件IIC                       |
| ------ | ------------------------------ | ----------------------------- |
| 引脚   | 有固定的引脚                   | 可以自己定义引脚              |
| 代码   | 实现简单，只需调用相关控制函数 | 实现复杂，需要自己编写IIC时序 |
| 移植性 | 差                             | 好                            |
| 稳定性 | 据说用ST的IIC有bug             | 自己实现的放心                |
| 速度   | 速度快，可以达到几十MHz        | 速度相对较慢，几十kHz到400kHz |

**IIC优点：**

1、只需要两根线

2、支持多个主机和从机

3、有应答机制

**IIC缺点：**

1、传输速率比SPI慢

2、数据帧大小只能限制为8位

3、只能进行半双工通信



# SPI

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828230710943.png" alt="image-20230828230710943" style="zoom: 33%;" />

### SPI组成：

SCLK：串行时钟线

CS/SS：从设备片选信号线，将某个设备的片选线拉到**低电平**，表示选中该从设备。

MISO：主设备输入、从设备输出

MOSI：主设备输出、从设备输入

**SPI最大速度**：SPI最大传输速率一般为系统时钟频率的1/2，现在已经有SPI达到50MHz。

SPI支持一主多从



**SPI通信过程：**

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828233831449.png" alt="image-20230828233831449" style="zoom:50%;" />

1、主设备发起信号，将CS/SS拉低，启动通信。

2、主设备通过发送SCLK时钟信号，来告诉从设备进行写读数据操作，它将立即读取数据线上的信号，这样就得到了一位数据（1bit）。

3、主机（Master）将要发送的数据写到发送数据缓存区（Menory），缓存区经过移位寄存器，串行移位寄存器通过**MOSI信号线**将字节一位一位的移出去传送给从机，同时**MISO接口**接收到的数据经过移位寄存器一位一位的移到接收缓存区。

4、从机（Slave）也将自己的串行移位寄存器中的内容通过**MISO信号线**返回给主机。同时通过**MOSI信号线**接收主机发送的数据，这样，两个移位寄存器中的内容就被交换。



**四种通信模式：**

模式0：CPOL=0，CPHA=0：当空闲态时，SCLK处于低电平，数据采集是在第1个边沿，SCLK由**低电平**到**高电平**的跳变，所以数据采样是在上升沿，数据发送是在下降沿。

模式1：CPOL=0，CPHA=1：当空闲态时，SCLK处于低电平，数据采集是在第2个边沿，SCLK由**高电平**到**低电平**的跳变，所以数据采样是在下降沿，数据发送是在上升沿。

模式2：CPOL=1，CPHA=0：当空闲态时，SCLK处于高电平，数据采集是在第1个边沿，SCLK由**高电平**到**低电平**的跳变，所以数据采集是在下降沿，数据发送是在上升沿。

模式3：CPOL=1，CPHA=1：当空闲态时，SCLK处于高电平，数据采集是在第2个边沿，SCLK由**低电平**到**高电平**的跳变，所以数据采集是在上升沿，数据发送是在下降沿。

<img src="C:\Users\86155\AppData\Roaming\Typora\typora-user-images\image-20230828234657583.png" alt="image-20230828234657583" style="zoom:67%;" />

**SPI优点：**

1、数据传输速率快

2、全双工串行通信，所以可以同时发送和接收数据。

3、没有起始位和停止位，所以可以连续传输数据不会中断。

4、因为使用CS，所以不需要像IIC一样复杂的设备寻址系统。

5、灵活的数据传输方式，不限于8位，可以是任何大小的字。



**SPI缺点：**

1、使用四根线，比UART和IIC多两根线

2、每一个从设备都要使用一个片选线CS

3、只允许单主机

4、无法确认数据是否接收成功（IIC可以确认）

5、没有错误检查（UART可以进行错误检查）



